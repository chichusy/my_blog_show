<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -3.6. softmaxå›å½’çš„ä»é›¶å¼€å§‹å®ç° ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 import torch from IPython import display from d2l import torch as d2l # å›¾åƒé¢„å¤„ç†æµæ°´çº¿ï¼ˆload_data_fashion_mnistç”¨åˆ°ï¼‰ from torchvision import transforms # æ•°æ®é›†åŠ è½½ï¼ˆload_data_fashion_mnistç”¨åˆ°FashionMNISTï¼‰ import torchvision # DataLoaderç­‰æ•°æ®æ‰¹å¤„ç†å·¥å…·ï¼ˆload_data_fashion_mnistç­‰ç”¨åˆ°ï¼‰ from torch.utils import data # é€‰æ‹©æ•°æ®åŠ è½½çº¿ç¨‹æ•° def get_dataloader_workers(): &#34;&#34;&#34;ä½¿ç”¨å¤šå°‘ä¸ªè¿›ç¨‹æ¥è¯»å–æ•°æ®ã€‚winå»ºè®®1ï¼Œlinuxå»ºè®®4&#34;&#34;&#34; return 4 # æ•°æ®åŠ è½½ä¸é¢„å¤„ç† def load_data_fashion_mnist(batch_size, resize=None): #@save # 1. åˆ›å»ºå¤„ç†æ“ä½œåˆ—è¡¨ï¼ˆå…ˆè½¬å¼ é‡ï¼Œå¿…è¦æ—¶resizeæ’åœ¨å‰é¢ï¼‰ # transæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º1çš„åˆ—è¡¨ï¼Œåªæœ‰ToTensor()æ“ä½œçš„è¿™ä¸€ä¸ªå…ƒç´  trans = [transforms.ToTensor()] # å¦‚æœæœ‰resizeæ“ä½œï¼Œå°†å…¶æ’å…¥transåˆ—è¡¨ä¸­çš„é¦–ä½ if resize: trans.insert(0, transforms.Resize(resize)) # 2. ç»„è£…æˆå¤åˆå˜æ¢å™¨ trans = transforms.Compose(trans) # 3. åŠ è½½è®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼ˆå›¾ç‰‡å°†è‡ªåŠ¨åšä¸Šè¿°é¢„å¤„ç†ï¼‰ mnist_train = torchvision.datasets.FashionMNIST( root=&#34;../data&#34;, train=True, transform=trans, download=True) mnist_test = torchvision.datasets.FashionMNIST( root=&#34;../data&#34;, train=False, transform=trans, download=True) # 4. ç”¨DataLoaderåˆ†æ‰¹åŠ è½½ï¼ˆè®­ç»ƒé›†æ‰“ä¹±ï¼Œæµ‹è¯•é›†ä¸æ‰“ä¹±ï¼‰ return (data.DataLoader(mnist_train, batch_size, shuffle=True, num_workers=get_dataloader_workers()), data.DataLoader(mnist_test, batch_size, shuffle=False, num_workers=get_dataloader_workers())) # è·å–è®­ç»ƒã€æµ‹è¯•é›†æ•°æ®æ‰¹é‡è¿­ä»£å™¨ batch_size = 256 train_iter, test_iter = load_data_fashion_mnist(batch_size) # å‚æ•°åˆå§‹åŒ– # 28*28åƒç´ =784ï¼Œè¾“å…¥ç‰¹å¾é•¿åº¦ num_inputs = 784 # 10ç±»ï¼ˆæ¯ä¸ªå›¾ç‰‡å±äº0~9ä¹‹ä¸€ï¼‰ num_outputs = 10 # æƒé‡å‚æ•°ï¼ˆæ­£æ€åˆ†å¸ƒåˆå§‹åŒ–ï¼‰ï¼Œå½¢çŠ¶[784,10] W = torch.normal(0, 0.01, size=(num_inputs, num_outputs), requires_grad=True) b = torch.zeros(num_outputs, requires_grad=True) # åç½®å‚æ•° # Softmaxå‡½æ•° def softmax(X): X_exp = torch.exp(X) # å¯¹æ¯ä¸ªå…ƒç´ åšæŒ‡æ•°è¿ç®— partition = X_exp.sum(1, keepdim=True) # æ¯è¡Œæ±‚å’Œå¾—åˆ°åˆ†æ¯ï¼ˆåˆ—å‘é‡ï¼‰ï¼Œä¿ç•™äºŒç»´ç»“æ„ return X_exp / partition # ç”¨å¹¿æ’­æœºåˆ¶ï¼Œæ¯ä¸ªå…ƒç´ é™¤ä»¥å¯¹åº”åˆ†æ¯ï¼Œå¾—åˆ°æ¦‚ç‡ # çº¿æ€§åˆ†ç±»å™¨ï¼ˆå‰å‘ä¼ æ’­ï¼‰ def net(X): # 1. Xå±•å¹³æˆäºŒç»´(batch,784)ï¼›2. ä¹˜ä»¥æƒé‡å†åŠ åç½®ï¼›3. é€å…¥softmaxå¾—åˆ°æ¦‚ç‡ return softmax(torch.matmul(X.reshape((-1, W.shape[0])), W) + b) # äº¤å‰ç†µæŸå¤±å‡½æ•° def cross_entropy(y_hat, y): # å–æ¯ä¸ªæ ·æœ¬çœŸå®ç±»åˆ«çš„æ¦‚ç‡ï¼Œå–å¯¹æ•°åå–è´Ÿï¼Œå¾—åˆ°æŸå¤± return - torch.log(y_hat[range(len(y_hat)), y]) # è®¡ç®—å‡†ç¡®ç‡çš„å‡½æ•° def accuracy(y_hat, y): #@save &#34;&#34;&#34;è®¡ç®—é¢„æµ‹æ­£ç¡®çš„æ•°é‡&#34;&#34;&#34; # å¦‚æœy_hatæ˜¯æ¦‚ç‡åˆ†å¸ƒï¼Œå…ˆè½¬æˆé¢„æµ‹ç±»åˆ«ï¼ˆå–æœ€å¤§æ¦‚ç‡çš„ä¸‹æ ‡ï¼‰ if len(y_hat.shape) &gt; 1 and y_hat.shape[1] &gt; 1: y_hat = y_hat.argmax(axis=1) # æ¯”è¾ƒé¢„æµ‹ç±»åˆ«å’ŒçœŸå®æ ‡ç­¾ï¼Œå¾—åˆ°å¸ƒå°”å‹ï¼ˆTrue/Falseï¼‰ cmp = y_hat.type(y.dtype) == y return float(cmp.type(y.dtype).sum()) # ç»Ÿè®¡é¢„æµ‹æ­£ç¡®ä¸ªæ•° # åœ¨å®Œæ•´æ•°æ®é›†ä¸Šè¯„ä¼°å‡†ç¡®ç‡ def evaluate_accuracy(net, data_iter): &#34;&#34;&#34;è®¡ç®—åœ¨æŒ‡å®šæ•°æ®é›†ä¸Šæ¨¡å‹çš„ç²¾åº¦&#34;&#34;&#34; if isinstance(net, torch.nn.Module): net.eval() # å¦‚æœæ˜¯æ ‡å‡†PyTorchæ¨¡å‹ï¼Œåˆ‡æ¢åˆ°è¯„ä¼°æ¨¡å¼ metric = Accumulator(2) # [é¢„æµ‹å¯¹æ•°ï¼Œæ€»æ ·æœ¬æ•°] with torch.no_grad(): # ç¦ç”¨æ¢¯åº¦ï¼ŒèŠ‚çœå†…å­˜å’Œè®¡ç®— for X, y in data_iter: metric.add(accuracy(net(X), y), y.numel()) return metric[0] / metric[1] # è¿”å›å‡†ç¡®ç‡ # å¤šå˜é‡ç´¯åŠ å™¨å·¥å…·ç±» class Accumulator: #@save &#34;&#34;&#34;åœ¨nä¸ªå˜é‡ä¸Šç´¯åŠ &#34;&#34;&#34; def __init__(self, n): self.data = [0.0] * n # åˆå§‹åŒ–é•¿åº¦ä¸ºnçš„åˆ—è¡¨ def add(self, *args): self.data = [a + float(b) for a, b in zip(self.data, args)] # ä½ç½®å¯¹é½ç›¸åŠ  def reset(self): self.data = [0.0] * len(self.data) # __getitem__æ˜¯pythonå†…ç½®çš„é­”æ³•æ–¹æ³• def __getitem__(self, idx): return self.data[idx] # æ”¯æŒç´¢å¼•è¯»å–ï¼ˆobj[idx]ï¼‰ # ç¤ºä¾‹ï¼šè¯„ä¼°å½“å‰ç½‘ç»œåœ¨æµ‹è¯•é›†ä¸Šçš„å‡†ç¡®ç‡ evaluate_accuracy(net, test_iter) # è®­ç»ƒä¸€è½®epoch def train_epoch_ch3(net, train_iter, loss, updater): #@save &#34;&#34;&#34;è®­ç»ƒæ¨¡å‹ä¸€ä¸ªè¿­ä»£å‘¨æœŸ&#34;&#34;&#34; if isinstance(net, torch.nn.Module): net.train() # å¦‚æœæ˜¯æ ‡å‡†æ¨¡å‹ï¼Œåˆ‡æ¢åˆ°è®­ç»ƒæ¨¡å¼ metric = Accumulator(3) # [æŸå¤±å’Œï¼Œé¢„æµ‹å¯¹æ•°ï¼Œæ ·æœ¬æ€»æ•°] for X, y in train_iter: # å‰å‘ä¼ æ’­ï¼Œè®¡ç®—é¢„æµ‹å’ŒæŸå¤± y_hat = net(X) l = loss(y_hat, y) # åå‘ä¼ æ’­ä¸å‚æ•°æ›´æ–°ï¼ˆä¸¤ç§æƒ…å†µï¼‰ if isinstance(updater, torch.optim.Optimizer): updater.zero_grad() l.mean().backward() updater.step() else: l.sum().backward() updater(X.shape[0]) # ç´¯åŠ ç»Ÿè®¡é‡ metric.add(float(l.sum()), accuracy(y_hat, y), y.numel()) # è¿”å›å¹³å‡æŸå¤±å’Œå‡†ç¡®ç‡ return metric[0] / metric[2], metric[1] / metric[2] # è®­ç»ƒè¿‡ç¨‹åŠ¨ç”»å¯è§†åŒ–ç±» class Animator: #@save &#34;&#34;&#34;åœ¨åŠ¨ç”»ä¸­ç»˜åˆ¶æ•°æ®ï¼ˆæ”¯æŒå¤šæ›²çº¿ï¼‰&#34;&#34;&#34; def __init__(self, xlabel=None, ylabel=None, legend=None, xlim=None, ylim=None, xscale=&#39;linear&#39;, yscale=&#39;linear&#39;, fmts=(&#39;-&#39;, &#39;m--&#39;, &#39;g-.&#39;, &#39;r:&#39;), nrows=1, ncols=1, figsize=(3.5, 2.5)): if legend is None: legend = [] d2l.use_svg_display() self.fig, self.axes = d2l.plt.subplots(nrows, ncols, figsize=figsize) if nrows * ncols == 1: self.axes = [self.axes, ] # ä¼ é€’é…ç½®å‚æ•°ï¼Œä¾¿äºåç»­é‡ç»˜ self.config_axes = lambda: d2l.set_axes( self.axes[0], xlabel, ylabel, xlim, ylim, xscale, yscale, legend) self.X, self.Y, self.fmts = None, None, fmts def add(self, x, y): # å¢é‡å¼æ·»åŠ å¤šä¸ªæ•°æ®ç‚¹åˆ°æ›²çº¿ if not hasattr(y, &#34;__len__&#34;): y = [y] n = len(y) if not hasattr(x, &#34;__len__&#34;): x = [x] * n if not self.X: self.X = [[] for _ in range(n)] if not self.Y: self.Y = [[] for _ in range(n)] for i, (a, b) in enumerate(zip(x, y)): if a is not None and b is not None: self.X[i].append(a) self.Y[i].append(b) self.axes[0].cla() # æ¸…é™¤æ—§å†…å®¹ for x, y, fmt in zip(self.X, self.Y, self.fmts): self.axes[0].plot(x, y, fmt) self.config_axes() display.display(self.fig) display.clear_output(wait=True) # æ€»æ§è®­ç»ƒä¸»æµç¨‹å‡½æ•° def train_ch3(net, train_iter, test_iter, loss, num_epochs, updater): #@save &#34;&#34;&#34;è®­ç»ƒä¸»æ§æµç¨‹ï¼šæ¯epochè®­ç»ƒ/è¯„ä¼°/å¯è§†åŒ–&#34;&#34;&#34; animator = Animator(xlabel=&#39;epoch&#39;, xlim=[1, num_epochs], ylim=[0.3, 0.9], legend=[&#39;train loss&#39;, &#39;train acc&#39;, &#39;test acc&#39;]) for epoch in range(num_epochs): train_metrics = train_epoch_ch3(net, train_iter, loss, updater) # è®­ç»ƒä¸€è½® test_acc = evaluate_accuracy(net, test_iter) # æµ‹è¯•é›†è¯„ä¼° animator.add(epoch + 1, train_metrics + (test_acc,)) # ç”»æ›²çº¿ train_loss, train_acc = train_metrics # è‡ªåŠ¨æ£€æµ‹æ¨¡å‹æ•ˆæœ assert train_loss &lt; 0.5, train_loss assert train_acc &lt;= 1 and train_acc &gt; 0.7, train_acc assert test_acc &lt;= 1 and test_acc &gt; 0.7, test_acc # å­¦ä¹ ç‡ lr = 0.1 def updater(batch_size): # ç”¨d2lçš„SGDä¼˜åŒ–å™¨ return d2l.sgd([W, b], lr, batch_size) num_epochs = 10 # å¼€å§‹è®­ç»ƒå¹¶åŠ¨æ€å¯è§†åŒ– train_ch3(net, train_iter, test_iter, cross_entropy, num_epochs, updater) # å¯è§†åŒ–é¢„æµ‹æ•ˆæœçš„å‡½æ•° def predict_ch3(net, test_iter, n=6): #@save &#34;&#34;&#34;éšæœºé€‰nå¼ å›¾ç‰‡ï¼Œå±•ç¤ºçœŸå®å’Œé¢„æµ‹æ ‡ç­¾&#34;&#34;&#34; for X, y in test_iter: break # å–ç¬¬ä¸€ä¸ªbatch trues = d2l.get_fashion_mnist_labels(y) # çœŸå®æ ‡ç­¾ï¼ˆè½¬æ–‡æœ¬ï¼‰ preds = d2l.get_fashion_mnist_labels(net(X).argmax(axis=1)) # é¢„æµ‹æ ‡ç­¾ï¼ˆè½¬æ–‡æœ¬ï¼‰ # åˆå¹¶â€œçœŸå®+é¢„æµ‹â€ä½œä¸ºæ ‡é¢˜ titles = [true +&#39;\\n&#39; + pred for true, pred in zip(trues, preds)] # å¯è§†åŒ–å‰nå¼ å›¾ç‰‡åŠæ ‡ç­¾ d2l.show_images( X[0:n].reshape((n, 28, 28)), 1, n, titles=titles[0:n]) # è¿è¡Œé¢„æµ‹å’Œå¯è§†åŒ– predict_ch3(net, test_iter) è¿è¡Œç»“æœ ">
<title>åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -3.6. softmaxå›å½’çš„ä»é›¶å¼€å§‹å®ç°</title>

<link rel='canonical' href='https://example.com/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.6.-softmax%E5%9B%9E%E5%BD%92%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0/'>

<link rel="stylesheet" href="/scss/style.min.76d56cb8dfd27db635f813412aada78a21b66f7863415f1fa2503126dbbf502d.css"><meta property='og:title' content="åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -3.6. softmaxå›å½’çš„ä»é›¶å¼€å§‹å®ç°">
<meta property='og:description' content="åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -3.6. softmaxå›å½’çš„ä»é›¶å¼€å§‹å®ç° ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 import torch from IPython import display from d2l import torch as d2l # å›¾åƒé¢„å¤„ç†æµæ°´çº¿ï¼ˆload_data_fashion_mnistç”¨åˆ°ï¼‰ from torchvision import transforms # æ•°æ®é›†åŠ è½½ï¼ˆload_data_fashion_mnistç”¨åˆ°FashionMNISTï¼‰ import torchvision # DataLoaderç­‰æ•°æ®æ‰¹å¤„ç†å·¥å…·ï¼ˆload_data_fashion_mnistç­‰ç”¨åˆ°ï¼‰ from torch.utils import data # é€‰æ‹©æ•°æ®åŠ è½½çº¿ç¨‹æ•° def get_dataloader_workers(): &#34;&#34;&#34;ä½¿ç”¨å¤šå°‘ä¸ªè¿›ç¨‹æ¥è¯»å–æ•°æ®ã€‚winå»ºè®®1ï¼Œlinuxå»ºè®®4&#34;&#34;&#34; return 4 # æ•°æ®åŠ è½½ä¸é¢„å¤„ç† def load_data_fashion_mnist(batch_size, resize=None): #@save # 1. åˆ›å»ºå¤„ç†æ“ä½œåˆ—è¡¨ï¼ˆå…ˆè½¬å¼ é‡ï¼Œå¿…è¦æ—¶resizeæ’åœ¨å‰é¢ï¼‰ # transæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º1çš„åˆ—è¡¨ï¼Œåªæœ‰ToTensor()æ“ä½œçš„è¿™ä¸€ä¸ªå…ƒç´  trans = [transforms.ToTensor()] # å¦‚æœæœ‰resizeæ“ä½œï¼Œå°†å…¶æ’å…¥transåˆ—è¡¨ä¸­çš„é¦–ä½ if resize: trans.insert(0, transforms.Resize(resize)) # 2. ç»„è£…æˆå¤åˆå˜æ¢å™¨ trans = transforms.Compose(trans) # 3. åŠ è½½è®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼ˆå›¾ç‰‡å°†è‡ªåŠ¨åšä¸Šè¿°é¢„å¤„ç†ï¼‰ mnist_train = torchvision.datasets.FashionMNIST( root=&#34;../data&#34;, train=True, transform=trans, download=True) mnist_test = torchvision.datasets.FashionMNIST( root=&#34;../data&#34;, train=False, transform=trans, download=True) # 4. ç”¨DataLoaderåˆ†æ‰¹åŠ è½½ï¼ˆè®­ç»ƒé›†æ‰“ä¹±ï¼Œæµ‹è¯•é›†ä¸æ‰“ä¹±ï¼‰ return (data.DataLoader(mnist_train, batch_size, shuffle=True, num_workers=get_dataloader_workers()), data.DataLoader(mnist_test, batch_size, shuffle=False, num_workers=get_dataloader_workers())) # è·å–è®­ç»ƒã€æµ‹è¯•é›†æ•°æ®æ‰¹é‡è¿­ä»£å™¨ batch_size = 256 train_iter, test_iter = load_data_fashion_mnist(batch_size) # å‚æ•°åˆå§‹åŒ– # 28*28åƒç´ =784ï¼Œè¾“å…¥ç‰¹å¾é•¿åº¦ num_inputs = 784 # 10ç±»ï¼ˆæ¯ä¸ªå›¾ç‰‡å±äº0~9ä¹‹ä¸€ï¼‰ num_outputs = 10 # æƒé‡å‚æ•°ï¼ˆæ­£æ€åˆ†å¸ƒåˆå§‹åŒ–ï¼‰ï¼Œå½¢çŠ¶[784,10] W = torch.normal(0, 0.01, size=(num_inputs, num_outputs), requires_grad=True) b = torch.zeros(num_outputs, requires_grad=True) # åç½®å‚æ•° # Softmaxå‡½æ•° def softmax(X): X_exp = torch.exp(X) # å¯¹æ¯ä¸ªå…ƒç´ åšæŒ‡æ•°è¿ç®— partition = X_exp.sum(1, keepdim=True) # æ¯è¡Œæ±‚å’Œå¾—åˆ°åˆ†æ¯ï¼ˆåˆ—å‘é‡ï¼‰ï¼Œä¿ç•™äºŒç»´ç»“æ„ return X_exp / partition # ç”¨å¹¿æ’­æœºåˆ¶ï¼Œæ¯ä¸ªå…ƒç´ é™¤ä»¥å¯¹åº”åˆ†æ¯ï¼Œå¾—åˆ°æ¦‚ç‡ # çº¿æ€§åˆ†ç±»å™¨ï¼ˆå‰å‘ä¼ æ’­ï¼‰ def net(X): # 1. Xå±•å¹³æˆäºŒç»´(batch,784)ï¼›2. ä¹˜ä»¥æƒé‡å†åŠ åç½®ï¼›3. é€å…¥softmaxå¾—åˆ°æ¦‚ç‡ return softmax(torch.matmul(X.reshape((-1, W.shape[0])), W) + b) # äº¤å‰ç†µæŸå¤±å‡½æ•° def cross_entropy(y_hat, y): # å–æ¯ä¸ªæ ·æœ¬çœŸå®ç±»åˆ«çš„æ¦‚ç‡ï¼Œå–å¯¹æ•°åå–è´Ÿï¼Œå¾—åˆ°æŸå¤± return - torch.log(y_hat[range(len(y_hat)), y]) # è®¡ç®—å‡†ç¡®ç‡çš„å‡½æ•° def accuracy(y_hat, y): #@save &#34;&#34;&#34;è®¡ç®—é¢„æµ‹æ­£ç¡®çš„æ•°é‡&#34;&#34;&#34; # å¦‚æœy_hatæ˜¯æ¦‚ç‡åˆ†å¸ƒï¼Œå…ˆè½¬æˆé¢„æµ‹ç±»åˆ«ï¼ˆå–æœ€å¤§æ¦‚ç‡çš„ä¸‹æ ‡ï¼‰ if len(y_hat.shape) &gt; 1 and y_hat.shape[1] &gt; 1: y_hat = y_hat.argmax(axis=1) # æ¯”è¾ƒé¢„æµ‹ç±»åˆ«å’ŒçœŸå®æ ‡ç­¾ï¼Œå¾—åˆ°å¸ƒå°”å‹ï¼ˆTrue/Falseï¼‰ cmp = y_hat.type(y.dtype) == y return float(cmp.type(y.dtype).sum()) # ç»Ÿè®¡é¢„æµ‹æ­£ç¡®ä¸ªæ•° # åœ¨å®Œæ•´æ•°æ®é›†ä¸Šè¯„ä¼°å‡†ç¡®ç‡ def evaluate_accuracy(net, data_iter): &#34;&#34;&#34;è®¡ç®—åœ¨æŒ‡å®šæ•°æ®é›†ä¸Šæ¨¡å‹çš„ç²¾åº¦&#34;&#34;&#34; if isinstance(net, torch.nn.Module): net.eval() # å¦‚æœæ˜¯æ ‡å‡†PyTorchæ¨¡å‹ï¼Œåˆ‡æ¢åˆ°è¯„ä¼°æ¨¡å¼ metric = Accumulator(2) # [é¢„æµ‹å¯¹æ•°ï¼Œæ€»æ ·æœ¬æ•°] with torch.no_grad(): # ç¦ç”¨æ¢¯åº¦ï¼ŒèŠ‚çœå†…å­˜å’Œè®¡ç®— for X, y in data_iter: metric.add(accuracy(net(X), y), y.numel()) return metric[0] / metric[1] # è¿”å›å‡†ç¡®ç‡ # å¤šå˜é‡ç´¯åŠ å™¨å·¥å…·ç±» class Accumulator: #@save &#34;&#34;&#34;åœ¨nä¸ªå˜é‡ä¸Šç´¯åŠ &#34;&#34;&#34; def __init__(self, n): self.data = [0.0] * n # åˆå§‹åŒ–é•¿åº¦ä¸ºnçš„åˆ—è¡¨ def add(self, *args): self.data = [a + float(b) for a, b in zip(self.data, args)] # ä½ç½®å¯¹é½ç›¸åŠ  def reset(self): self.data = [0.0] * len(self.data) # __getitem__æ˜¯pythonå†…ç½®çš„é­”æ³•æ–¹æ³• def __getitem__(self, idx): return self.data[idx] # æ”¯æŒç´¢å¼•è¯»å–ï¼ˆobj[idx]ï¼‰ # ç¤ºä¾‹ï¼šè¯„ä¼°å½“å‰ç½‘ç»œåœ¨æµ‹è¯•é›†ä¸Šçš„å‡†ç¡®ç‡ evaluate_accuracy(net, test_iter) # è®­ç»ƒä¸€è½®epoch def train_epoch_ch3(net, train_iter, loss, updater): #@save &#34;&#34;&#34;è®­ç»ƒæ¨¡å‹ä¸€ä¸ªè¿­ä»£å‘¨æœŸ&#34;&#34;&#34; if isinstance(net, torch.nn.Module): net.train() # å¦‚æœæ˜¯æ ‡å‡†æ¨¡å‹ï¼Œåˆ‡æ¢åˆ°è®­ç»ƒæ¨¡å¼ metric = Accumulator(3) # [æŸå¤±å’Œï¼Œé¢„æµ‹å¯¹æ•°ï¼Œæ ·æœ¬æ€»æ•°] for X, y in train_iter: # å‰å‘ä¼ æ’­ï¼Œè®¡ç®—é¢„æµ‹å’ŒæŸå¤± y_hat = net(X) l = loss(y_hat, y) # åå‘ä¼ æ’­ä¸å‚æ•°æ›´æ–°ï¼ˆä¸¤ç§æƒ…å†µï¼‰ if isinstance(updater, torch.optim.Optimizer): updater.zero_grad() l.mean().backward() updater.step() else: l.sum().backward() updater(X.shape[0]) # ç´¯åŠ ç»Ÿè®¡é‡ metric.add(float(l.sum()), accuracy(y_hat, y), y.numel()) # è¿”å›å¹³å‡æŸå¤±å’Œå‡†ç¡®ç‡ return metric[0] / metric[2], metric[1] / metric[2] # è®­ç»ƒè¿‡ç¨‹åŠ¨ç”»å¯è§†åŒ–ç±» class Animator: #@save &#34;&#34;&#34;åœ¨åŠ¨ç”»ä¸­ç»˜åˆ¶æ•°æ®ï¼ˆæ”¯æŒå¤šæ›²çº¿ï¼‰&#34;&#34;&#34; def __init__(self, xlabel=None, ylabel=None, legend=None, xlim=None, ylim=None, xscale=&#39;linear&#39;, yscale=&#39;linear&#39;, fmts=(&#39;-&#39;, &#39;m--&#39;, &#39;g-.&#39;, &#39;r:&#39;), nrows=1, ncols=1, figsize=(3.5, 2.5)): if legend is None: legend = [] d2l.use_svg_display() self.fig, self.axes = d2l.plt.subplots(nrows, ncols, figsize=figsize) if nrows * ncols == 1: self.axes = [self.axes, ] # ä¼ é€’é…ç½®å‚æ•°ï¼Œä¾¿äºåç»­é‡ç»˜ self.config_axes = lambda: d2l.set_axes( self.axes[0], xlabel, ylabel, xlim, ylim, xscale, yscale, legend) self.X, self.Y, self.fmts = None, None, fmts def add(self, x, y): # å¢é‡å¼æ·»åŠ å¤šä¸ªæ•°æ®ç‚¹åˆ°æ›²çº¿ if not hasattr(y, &#34;__len__&#34;): y = [y] n = len(y) if not hasattr(x, &#34;__len__&#34;): x = [x] * n if not self.X: self.X = [[] for _ in range(n)] if not self.Y: self.Y = [[] for _ in range(n)] for i, (a, b) in enumerate(zip(x, y)): if a is not None and b is not None: self.X[i].append(a) self.Y[i].append(b) self.axes[0].cla() # æ¸…é™¤æ—§å†…å®¹ for x, y, fmt in zip(self.X, self.Y, self.fmts): self.axes[0].plot(x, y, fmt) self.config_axes() display.display(self.fig) display.clear_output(wait=True) # æ€»æ§è®­ç»ƒä¸»æµç¨‹å‡½æ•° def train_ch3(net, train_iter, test_iter, loss, num_epochs, updater): #@save &#34;&#34;&#34;è®­ç»ƒä¸»æ§æµç¨‹ï¼šæ¯epochè®­ç»ƒ/è¯„ä¼°/å¯è§†åŒ–&#34;&#34;&#34; animator = Animator(xlabel=&#39;epoch&#39;, xlim=[1, num_epochs], ylim=[0.3, 0.9], legend=[&#39;train loss&#39;, &#39;train acc&#39;, &#39;test acc&#39;]) for epoch in range(num_epochs): train_metrics = train_epoch_ch3(net, train_iter, loss, updater) # è®­ç»ƒä¸€è½® test_acc = evaluate_accuracy(net, test_iter) # æµ‹è¯•é›†è¯„ä¼° animator.add(epoch + 1, train_metrics + (test_acc,)) # ç”»æ›²çº¿ train_loss, train_acc = train_metrics # è‡ªåŠ¨æ£€æµ‹æ¨¡å‹æ•ˆæœ assert train_loss &lt; 0.5, train_loss assert train_acc &lt;= 1 and train_acc &gt; 0.7, train_acc assert test_acc &lt;= 1 and test_acc &gt; 0.7, test_acc # å­¦ä¹ ç‡ lr = 0.1 def updater(batch_size): # ç”¨d2lçš„SGDä¼˜åŒ–å™¨ return d2l.sgd([W, b], lr, batch_size) num_epochs = 10 # å¼€å§‹è®­ç»ƒå¹¶åŠ¨æ€å¯è§†åŒ– train_ch3(net, train_iter, test_iter, cross_entropy, num_epochs, updater) # å¯è§†åŒ–é¢„æµ‹æ•ˆæœçš„å‡½æ•° def predict_ch3(net, test_iter, n=6): #@save &#34;&#34;&#34;éšæœºé€‰nå¼ å›¾ç‰‡ï¼Œå±•ç¤ºçœŸå®å’Œé¢„æµ‹æ ‡ç­¾&#34;&#34;&#34; for X, y in test_iter: break # å–ç¬¬ä¸€ä¸ªbatch trues = d2l.get_fashion_mnist_labels(y) # çœŸå®æ ‡ç­¾ï¼ˆè½¬æ–‡æœ¬ï¼‰ preds = d2l.get_fashion_mnist_labels(net(X).argmax(axis=1)) # é¢„æµ‹æ ‡ç­¾ï¼ˆè½¬æ–‡æœ¬ï¼‰ # åˆå¹¶â€œçœŸå®+é¢„æµ‹â€ä½œä¸ºæ ‡é¢˜ titles = [true +&#39;\\n&#39; + pred for true, pred in zip(trues, preds)] # å¯è§†åŒ–å‰nå¼ å›¾ç‰‡åŠæ ‡ç­¾ d2l.show_images( X[0:n].reshape((n, 28, 28)), 1, n, titles=titles[0:n]) # è¿è¡Œé¢„æµ‹å’Œå¯è§†åŒ– predict_ch3(net, test_iter) è¿è¡Œç»“æœ ">
<meta property='og:url' content='https://example.com/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.6.-softmax%E5%9B%9E%E5%BD%92%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0/'>
<meta property='og:site_name' content='ç‹æ¶‘æ¯“çš„ä¸ªäººåšå®¢'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='å·¥ç¨‹å®è·µ' /><meta property='article:tag' content='åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ ' /><meta property='article:published_time' content='2025-08-07T14:44:25&#43;08:00'/><meta property='article:modified_time' content='2025-08-07T14:44:25&#43;08:00'/><meta property='og:image' content='https://example.com/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.6.-softmax%E5%9B%9E%E5%BD%92%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0/index.jpg' />
<meta name="twitter:title" content="åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -3.6. softmaxå›å½’çš„ä»é›¶å¼€å§‹å®ç°">
<meta name="twitter:description" content="åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -3.6. softmaxå›å½’çš„ä»é›¶å¼€å§‹å®ç° ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 import torch from IPython import display from d2l import torch as d2l # å›¾åƒé¢„å¤„ç†æµæ°´çº¿ï¼ˆload_data_fashion_mnistç”¨åˆ°ï¼‰ from torchvision import transforms # æ•°æ®é›†åŠ è½½ï¼ˆload_data_fashion_mnistç”¨åˆ°FashionMNISTï¼‰ import torchvision # DataLoaderç­‰æ•°æ®æ‰¹å¤„ç†å·¥å…·ï¼ˆload_data_fashion_mnistç­‰ç”¨åˆ°ï¼‰ from torch.utils import data # é€‰æ‹©æ•°æ®åŠ è½½çº¿ç¨‹æ•° def get_dataloader_workers(): &#34;&#34;&#34;ä½¿ç”¨å¤šå°‘ä¸ªè¿›ç¨‹æ¥è¯»å–æ•°æ®ã€‚winå»ºè®®1ï¼Œlinuxå»ºè®®4&#34;&#34;&#34; return 4 # æ•°æ®åŠ è½½ä¸é¢„å¤„ç† def load_data_fashion_mnist(batch_size, resize=None): #@save # 1. åˆ›å»ºå¤„ç†æ“ä½œåˆ—è¡¨ï¼ˆå…ˆè½¬å¼ é‡ï¼Œå¿…è¦æ—¶resizeæ’åœ¨å‰é¢ï¼‰ # transæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º1çš„åˆ—è¡¨ï¼Œåªæœ‰ToTensor()æ“ä½œçš„è¿™ä¸€ä¸ªå…ƒç´  trans = [transforms.ToTensor()] # å¦‚æœæœ‰resizeæ“ä½œï¼Œå°†å…¶æ’å…¥transåˆ—è¡¨ä¸­çš„é¦–ä½ if resize: trans.insert(0, transforms.Resize(resize)) # 2. ç»„è£…æˆå¤åˆå˜æ¢å™¨ trans = transforms.Compose(trans) # 3. åŠ è½½è®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼ˆå›¾ç‰‡å°†è‡ªåŠ¨åšä¸Šè¿°é¢„å¤„ç†ï¼‰ mnist_train = torchvision.datasets.FashionMNIST( root=&#34;../data&#34;, train=True, transform=trans, download=True) mnist_test = torchvision.datasets.FashionMNIST( root=&#34;../data&#34;, train=False, transform=trans, download=True) # 4. ç”¨DataLoaderåˆ†æ‰¹åŠ è½½ï¼ˆè®­ç»ƒé›†æ‰“ä¹±ï¼Œæµ‹è¯•é›†ä¸æ‰“ä¹±ï¼‰ return (data.DataLoader(mnist_train, batch_size, shuffle=True, num_workers=get_dataloader_workers()), data.DataLoader(mnist_test, batch_size, shuffle=False, num_workers=get_dataloader_workers())) # è·å–è®­ç»ƒã€æµ‹è¯•é›†æ•°æ®æ‰¹é‡è¿­ä»£å™¨ batch_size = 256 train_iter, test_iter = load_data_fashion_mnist(batch_size) # å‚æ•°åˆå§‹åŒ– # 28*28åƒç´ =784ï¼Œè¾“å…¥ç‰¹å¾é•¿åº¦ num_inputs = 784 # 10ç±»ï¼ˆæ¯ä¸ªå›¾ç‰‡å±äº0~9ä¹‹ä¸€ï¼‰ num_outputs = 10 # æƒé‡å‚æ•°ï¼ˆæ­£æ€åˆ†å¸ƒåˆå§‹åŒ–ï¼‰ï¼Œå½¢çŠ¶[784,10] W = torch.normal(0, 0.01, size=(num_inputs, num_outputs), requires_grad=True) b = torch.zeros(num_outputs, requires_grad=True) # åç½®å‚æ•° # Softmaxå‡½æ•° def softmax(X): X_exp = torch.exp(X) # å¯¹æ¯ä¸ªå…ƒç´ åšæŒ‡æ•°è¿ç®— partition = X_exp.sum(1, keepdim=True) # æ¯è¡Œæ±‚å’Œå¾—åˆ°åˆ†æ¯ï¼ˆåˆ—å‘é‡ï¼‰ï¼Œä¿ç•™äºŒç»´ç»“æ„ return X_exp / partition # ç”¨å¹¿æ’­æœºåˆ¶ï¼Œæ¯ä¸ªå…ƒç´ é™¤ä»¥å¯¹åº”åˆ†æ¯ï¼Œå¾—åˆ°æ¦‚ç‡ # çº¿æ€§åˆ†ç±»å™¨ï¼ˆå‰å‘ä¼ æ’­ï¼‰ def net(X): # 1. Xå±•å¹³æˆäºŒç»´(batch,784)ï¼›2. ä¹˜ä»¥æƒé‡å†åŠ åç½®ï¼›3. é€å…¥softmaxå¾—åˆ°æ¦‚ç‡ return softmax(torch.matmul(X.reshape((-1, W.shape[0])), W) + b) # äº¤å‰ç†µæŸå¤±å‡½æ•° def cross_entropy(y_hat, y): # å–æ¯ä¸ªæ ·æœ¬çœŸå®ç±»åˆ«çš„æ¦‚ç‡ï¼Œå–å¯¹æ•°åå–è´Ÿï¼Œå¾—åˆ°æŸå¤± return - torch.log(y_hat[range(len(y_hat)), y]) # è®¡ç®—å‡†ç¡®ç‡çš„å‡½æ•° def accuracy(y_hat, y): #@save &#34;&#34;&#34;è®¡ç®—é¢„æµ‹æ­£ç¡®çš„æ•°é‡&#34;&#34;&#34; # å¦‚æœy_hatæ˜¯æ¦‚ç‡åˆ†å¸ƒï¼Œå…ˆè½¬æˆé¢„æµ‹ç±»åˆ«ï¼ˆå–æœ€å¤§æ¦‚ç‡çš„ä¸‹æ ‡ï¼‰ if len(y_hat.shape) &gt; 1 and y_hat.shape[1] &gt; 1: y_hat = y_hat.argmax(axis=1) # æ¯”è¾ƒé¢„æµ‹ç±»åˆ«å’ŒçœŸå®æ ‡ç­¾ï¼Œå¾—åˆ°å¸ƒå°”å‹ï¼ˆTrue/Falseï¼‰ cmp = y_hat.type(y.dtype) == y return float(cmp.type(y.dtype).sum()) # ç»Ÿè®¡é¢„æµ‹æ­£ç¡®ä¸ªæ•° # åœ¨å®Œæ•´æ•°æ®é›†ä¸Šè¯„ä¼°å‡†ç¡®ç‡ def evaluate_accuracy(net, data_iter): &#34;&#34;&#34;è®¡ç®—åœ¨æŒ‡å®šæ•°æ®é›†ä¸Šæ¨¡å‹çš„ç²¾åº¦&#34;&#34;&#34; if isinstance(net, torch.nn.Module): net.eval() # å¦‚æœæ˜¯æ ‡å‡†PyTorchæ¨¡å‹ï¼Œåˆ‡æ¢åˆ°è¯„ä¼°æ¨¡å¼ metric = Accumulator(2) # [é¢„æµ‹å¯¹æ•°ï¼Œæ€»æ ·æœ¬æ•°] with torch.no_grad(): # ç¦ç”¨æ¢¯åº¦ï¼ŒèŠ‚çœå†…å­˜å’Œè®¡ç®— for X, y in data_iter: metric.add(accuracy(net(X), y), y.numel()) return metric[0] / metric[1] # è¿”å›å‡†ç¡®ç‡ # å¤šå˜é‡ç´¯åŠ å™¨å·¥å…·ç±» class Accumulator: #@save &#34;&#34;&#34;åœ¨nä¸ªå˜é‡ä¸Šç´¯åŠ &#34;&#34;&#34; def __init__(self, n): self.data = [0.0] * n # åˆå§‹åŒ–é•¿åº¦ä¸ºnçš„åˆ—è¡¨ def add(self, *args): self.data = [a + float(b) for a, b in zip(self.data, args)] # ä½ç½®å¯¹é½ç›¸åŠ  def reset(self): self.data = [0.0] * len(self.data) # __getitem__æ˜¯pythonå†…ç½®çš„é­”æ³•æ–¹æ³• def __getitem__(self, idx): return self.data[idx] # æ”¯æŒç´¢å¼•è¯»å–ï¼ˆobj[idx]ï¼‰ # ç¤ºä¾‹ï¼šè¯„ä¼°å½“å‰ç½‘ç»œåœ¨æµ‹è¯•é›†ä¸Šçš„å‡†ç¡®ç‡ evaluate_accuracy(net, test_iter) # è®­ç»ƒä¸€è½®epoch def train_epoch_ch3(net, train_iter, loss, updater): #@save &#34;&#34;&#34;è®­ç»ƒæ¨¡å‹ä¸€ä¸ªè¿­ä»£å‘¨æœŸ&#34;&#34;&#34; if isinstance(net, torch.nn.Module): net.train() # å¦‚æœæ˜¯æ ‡å‡†æ¨¡å‹ï¼Œåˆ‡æ¢åˆ°è®­ç»ƒæ¨¡å¼ metric = Accumulator(3) # [æŸå¤±å’Œï¼Œé¢„æµ‹å¯¹æ•°ï¼Œæ ·æœ¬æ€»æ•°] for X, y in train_iter: # å‰å‘ä¼ æ’­ï¼Œè®¡ç®—é¢„æµ‹å’ŒæŸå¤± y_hat = net(X) l = loss(y_hat, y) # åå‘ä¼ æ’­ä¸å‚æ•°æ›´æ–°ï¼ˆä¸¤ç§æƒ…å†µï¼‰ if isinstance(updater, torch.optim.Optimizer): updater.zero_grad() l.mean().backward() updater.step() else: l.sum().backward() updater(X.shape[0]) # ç´¯åŠ ç»Ÿè®¡é‡ metric.add(float(l.sum()), accuracy(y_hat, y), y.numel()) # è¿”å›å¹³å‡æŸå¤±å’Œå‡†ç¡®ç‡ return metric[0] / metric[2], metric[1] / metric[2] # è®­ç»ƒè¿‡ç¨‹åŠ¨ç”»å¯è§†åŒ–ç±» class Animator: #@save &#34;&#34;&#34;åœ¨åŠ¨ç”»ä¸­ç»˜åˆ¶æ•°æ®ï¼ˆæ”¯æŒå¤šæ›²çº¿ï¼‰&#34;&#34;&#34; def __init__(self, xlabel=None, ylabel=None, legend=None, xlim=None, ylim=None, xscale=&#39;linear&#39;, yscale=&#39;linear&#39;, fmts=(&#39;-&#39;, &#39;m--&#39;, &#39;g-.&#39;, &#39;r:&#39;), nrows=1, ncols=1, figsize=(3.5, 2.5)): if legend is None: legend = [] d2l.use_svg_display() self.fig, self.axes = d2l.plt.subplots(nrows, ncols, figsize=figsize) if nrows * ncols == 1: self.axes = [self.axes, ] # ä¼ é€’é…ç½®å‚æ•°ï¼Œä¾¿äºåç»­é‡ç»˜ self.config_axes = lambda: d2l.set_axes( self.axes[0], xlabel, ylabel, xlim, ylim, xscale, yscale, legend) self.X, self.Y, self.fmts = None, None, fmts def add(self, x, y): # å¢é‡å¼æ·»åŠ å¤šä¸ªæ•°æ®ç‚¹åˆ°æ›²çº¿ if not hasattr(y, &#34;__len__&#34;): y = [y] n = len(y) if not hasattr(x, &#34;__len__&#34;): x = [x] * n if not self.X: self.X = [[] for _ in range(n)] if not self.Y: self.Y = [[] for _ in range(n)] for i, (a, b) in enumerate(zip(x, y)): if a is not None and b is not None: self.X[i].append(a) self.Y[i].append(b) self.axes[0].cla() # æ¸…é™¤æ—§å†…å®¹ for x, y, fmt in zip(self.X, self.Y, self.fmts): self.axes[0].plot(x, y, fmt) self.config_axes() display.display(self.fig) display.clear_output(wait=True) # æ€»æ§è®­ç»ƒä¸»æµç¨‹å‡½æ•° def train_ch3(net, train_iter, test_iter, loss, num_epochs, updater): #@save &#34;&#34;&#34;è®­ç»ƒä¸»æ§æµç¨‹ï¼šæ¯epochè®­ç»ƒ/è¯„ä¼°/å¯è§†åŒ–&#34;&#34;&#34; animator = Animator(xlabel=&#39;epoch&#39;, xlim=[1, num_epochs], ylim=[0.3, 0.9], legend=[&#39;train loss&#39;, &#39;train acc&#39;, &#39;test acc&#39;]) for epoch in range(num_epochs): train_metrics = train_epoch_ch3(net, train_iter, loss, updater) # è®­ç»ƒä¸€è½® test_acc = evaluate_accuracy(net, test_iter) # æµ‹è¯•é›†è¯„ä¼° animator.add(epoch + 1, train_metrics + (test_acc,)) # ç”»æ›²çº¿ train_loss, train_acc = train_metrics # è‡ªåŠ¨æ£€æµ‹æ¨¡å‹æ•ˆæœ assert train_loss &lt; 0.5, train_loss assert train_acc &lt;= 1 and train_acc &gt; 0.7, train_acc assert test_acc &lt;= 1 and test_acc &gt; 0.7, test_acc # å­¦ä¹ ç‡ lr = 0.1 def updater(batch_size): # ç”¨d2lçš„SGDä¼˜åŒ–å™¨ return d2l.sgd([W, b], lr, batch_size) num_epochs = 10 # å¼€å§‹è®­ç»ƒå¹¶åŠ¨æ€å¯è§†åŒ– train_ch3(net, train_iter, test_iter, cross_entropy, num_epochs, updater) # å¯è§†åŒ–é¢„æµ‹æ•ˆæœçš„å‡½æ•° def predict_ch3(net, test_iter, n=6): #@save &#34;&#34;&#34;éšæœºé€‰nå¼ å›¾ç‰‡ï¼Œå±•ç¤ºçœŸå®å’Œé¢„æµ‹æ ‡ç­¾&#34;&#34;&#34; for X, y in test_iter: break # å–ç¬¬ä¸€ä¸ªbatch trues = d2l.get_fashion_mnist_labels(y) # çœŸå®æ ‡ç­¾ï¼ˆè½¬æ–‡æœ¬ï¼‰ preds = d2l.get_fashion_mnist_labels(net(X).argmax(axis=1)) # é¢„æµ‹æ ‡ç­¾ï¼ˆè½¬æ–‡æœ¬ï¼‰ # åˆå¹¶â€œçœŸå®+é¢„æµ‹â€ä½œä¸ºæ ‡é¢˜ titles = [true +&#39;\\n&#39; + pred for true, pred in zip(trues, preds)] # å¯è§†åŒ–å‰nå¼ å›¾ç‰‡åŠæ ‡ç­¾ d2l.show_images( X[0:n].reshape((n, 28, 28)), 1, n, titles=titles[0:n]) # è¿è¡Œé¢„æµ‹å’Œå¯è§†åŒ– predict_ch3(net, test_iter) è¿è¡Œç»“æœ "><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://example.com/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.6.-softmax%E5%9B%9E%E5%BD%92%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0/index.jpg' />
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/tx_hu_1ac2efbf4b10a9c1.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ˜</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">ç‹æ¶‘æ¯“çš„ä¸ªäººåšå®¢</a></h1>
            <h2 class="site-description">è¿™æ˜¯æˆ‘çš„ä¸ªäººåšå®¢ç½‘ç«™</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://space.bilibili.com/287094222'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v6a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4v-6z" /><path d="M8 3l2 3" /><path d="M16 3l-2 3" /><path d="M9 13v-2" /><path d="M15 11v2" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/chichusy'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>æœç´¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>é“¾æ¥</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#ä»£ç ">ä»£ç </a></li>
    <li><a href="#è¿è¡Œç»“æœ">è¿è¡Œç»“æœ</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.6.-softmax%E5%9B%9E%E5%BD%92%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0/">
                <img src="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.6.-softmax%E5%9B%9E%E5%BD%92%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0/index_hu_cfcbd6dc7d6e1043.jpg"
                        srcset="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.6.-softmax%E5%9B%9E%E5%BD%92%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0/index_hu_cfcbd6dc7d6e1043.jpg 800w, /p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.6.-softmax%E5%9B%9E%E5%BD%92%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0/index_hu_48fb903b3299f2ba.jpg 1600w"
                        width="800" 
                        height="1731" 
                        loading="lazy"
                        alt="Featured image of post åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -3.6. softmaxå›å½’çš„ä»é›¶å¼€å§‹å®ç°" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E5%AD%A6%E4%B9%A0/" >
                å­¦ä¹ 
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.6.-softmax%E5%9B%9E%E5%BD%92%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0/">åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -3.6. softmaxå›å½’çš„ä»é›¶å¼€å§‹å®ç°</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2025-08-07</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 5 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -36-softmaxå›å½’çš„ä»é›¶å¼€å§‹å®ç°">åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -3.6. softmaxå›å½’çš„ä»é›¶å¼€å§‹å®ç°
</h1><hr>
<h2 id="ä»£ç ">ä»£ç 
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">d2l</span> <span class="kn">import</span> <span class="n">torch</span> <span class="k">as</span> <span class="n">d2l</span>
</span></span><span class="line"><span class="cl"><span class="c1"># å›¾åƒé¢„å¤„ç†æµæ°´çº¿ï¼ˆload_data_fashion_mnistç”¨åˆ°ï¼‰</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
</span></span><span class="line"><span class="cl"><span class="c1"># æ•°æ®é›†åŠ è½½ï¼ˆload_data_fashion_mnistç”¨åˆ°FashionMNISTï¼‰</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torchvision</span>
</span></span><span class="line"><span class="cl"><span class="c1"># DataLoaderç­‰æ•°æ®æ‰¹å¤„ç†å·¥å…·ï¼ˆload_data_fashion_mnistç­‰ç”¨åˆ°ï¼‰</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">torch.utils</span> <span class="kn">import</span> <span class="n">data</span>           
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># é€‰æ‹©æ•°æ®åŠ è½½çº¿ç¨‹æ•°</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_dataloader_workers</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;ä½¿ç”¨å¤šå°‘ä¸ªè¿›ç¨‹æ¥è¯»å–æ•°æ®ã€‚winå»ºè®®1ï¼Œlinuxå»ºè®®4&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ•°æ®åŠ è½½ä¸é¢„å¤„ç†</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">load_data_fashion_mnist</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1">#@save</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 1. åˆ›å»ºå¤„ç†æ“ä½œåˆ—è¡¨ï¼ˆå…ˆè½¬å¼ é‡ï¼Œå¿…è¦æ—¶resizeæ’åœ¨å‰é¢ï¼‰</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># transæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º1çš„åˆ—è¡¨ï¼Œåªæœ‰ToTensor()æ“ä½œçš„è¿™ä¸€ä¸ªå…ƒç´ </span>
</span></span><span class="line"><span class="cl">    <span class="n">trans</span> <span class="o">=</span> <span class="p">[</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å¦‚æœæœ‰resizeæ“ä½œï¼Œå°†å…¶æ’å…¥transåˆ—è¡¨ä¸­çš„é¦–ä½</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">resize</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">trans</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">resize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="c1"># 2. ç»„è£…æˆå¤åˆå˜æ¢å™¨</span>
</span></span><span class="line"><span class="cl">    <span class="n">trans</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 3. åŠ è½½è®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼ˆå›¾ç‰‡å°†è‡ªåŠ¨åšä¸Šè¿°é¢„å¤„ç†ï¼‰</span>
</span></span><span class="line"><span class="cl">    <span class="n">mnist_train</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">root</span><span class="o">=</span><span class="s2">&#34;../data&#34;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">mnist_test</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">root</span><span class="o">=</span><span class="s2">&#34;../data&#34;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 4. ç”¨DataLoaderåˆ†æ‰¹åŠ è½½ï¼ˆè®­ç»ƒé›†æ‰“ä¹±ï¼Œæµ‹è¯•é›†ä¸æ‰“ä¹±ï¼‰</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">mnist_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">num_workers</span><span class="o">=</span><span class="n">get_dataloader_workers</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">mnist_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">num_workers</span><span class="o">=</span><span class="n">get_dataloader_workers</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è·å–è®­ç»ƒã€æµ‹è¯•é›†æ•°æ®æ‰¹é‡è¿­ä»£å™¨</span>
</span></span><span class="line"><span class="cl"><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl"><span class="n">train_iter</span><span class="p">,</span> <span class="n">test_iter</span> <span class="o">=</span> <span class="n">load_data_fashion_mnist</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å‚æ•°åˆå§‹åŒ–</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 28*28åƒç´ =784ï¼Œè¾“å…¥ç‰¹å¾é•¿åº¦</span>
</span></span><span class="line"><span class="cl"><span class="n">num_inputs</span> <span class="o">=</span> <span class="mi">784</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 10ç±»ï¼ˆæ¯ä¸ªå›¾ç‰‡å±äº0~9ä¹‹ä¸€ï¼‰</span>
</span></span><span class="line"><span class="cl"><span class="n">num_outputs</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æƒé‡å‚æ•°ï¼ˆæ­£æ€åˆ†å¸ƒåˆå§‹åŒ–ï¼‰ï¼Œå½¢çŠ¶[784,10]</span>
</span></span><span class="line"><span class="cl"><span class="n">W</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_inputs</span><span class="p">,</span> <span class="n">num_outputs</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_outputs</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># åç½®å‚æ•°</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Softmaxå‡½æ•°</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">softmax</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">X_exp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>                         <span class="c1"># å¯¹æ¯ä¸ªå…ƒç´ åšæŒ‡æ•°è¿ç®—</span>
</span></span><span class="line"><span class="cl">    <span class="n">partition</span> <span class="o">=</span> <span class="n">X_exp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>       <span class="c1"># æ¯è¡Œæ±‚å’Œå¾—åˆ°åˆ†æ¯ï¼ˆåˆ—å‘é‡ï¼‰ï¼Œä¿ç•™äºŒç»´ç»“æ„</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">X_exp</span> <span class="o">/</span> <span class="n">partition</span>                     <span class="c1"># ç”¨å¹¿æ’­æœºåˆ¶ï¼Œæ¯ä¸ªå…ƒç´ é™¤ä»¥å¯¹åº”åˆ†æ¯ï¼Œå¾—åˆ°æ¦‚ç‡</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># çº¿æ€§åˆ†ç±»å™¨ï¼ˆå‰å‘ä¼ æ’­ï¼‰</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">net</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 1. Xå±•å¹³æˆäºŒç»´(batch,784)ï¼›2. ä¹˜ä»¥æƒé‡å†åŠ åç½®ï¼›3. é€å…¥softmaxå¾—åˆ°æ¦‚ç‡</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">softmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># äº¤å‰ç†µæŸå¤±å‡½æ•°</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">cross_entropy</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å–æ¯ä¸ªæ ·æœ¬çœŸå®ç±»åˆ«çš„æ¦‚ç‡ï¼Œå–å¯¹æ•°åå–è´Ÿï¼Œå¾—åˆ°æŸå¤±</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_hat</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_hat</span><span class="p">)),</span> <span class="n">y</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è®¡ç®—å‡†ç¡®ç‡çš„å‡½æ•°</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">accuracy</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>  <span class="c1">#@save</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;è®¡ç®—é¢„æµ‹æ­£ç¡®çš„æ•°é‡&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å¦‚æœy_hatæ˜¯æ¦‚ç‡åˆ†å¸ƒï¼Œå…ˆè½¬æˆé¢„æµ‹ç±»åˆ«ï¼ˆå–æœ€å¤§æ¦‚ç‡çš„ä¸‹æ ‡ï¼‰</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">y_hat</span> <span class="o">=</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ¯”è¾ƒé¢„æµ‹ç±»åˆ«å’ŒçœŸå®æ ‡ç­¾ï¼Œå¾—åˆ°å¸ƒå°”å‹ï¼ˆTrue/Falseï¼‰</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmp</span> <span class="o">=</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">cmp</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>    <span class="c1"># ç»Ÿè®¡é¢„æµ‹æ­£ç¡®ä¸ªæ•°</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># åœ¨å®Œæ•´æ•°æ®é›†ä¸Šè¯„ä¼°å‡†ç¡®ç‡</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">evaluate_accuracy</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">data_iter</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;è®¡ç®—åœ¨æŒ‡å®šæ•°æ®é›†ä¸Šæ¨¡å‹çš„ç²¾åº¦&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>                      <span class="c1"># å¦‚æœæ˜¯æ ‡å‡†PyTorchæ¨¡å‹ï¼Œåˆ‡æ¢åˆ°è¯„ä¼°æ¨¡å¼</span>
</span></span><span class="line"><span class="cl">    <span class="n">metric</span> <span class="o">=</span> <span class="n">Accumulator</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>             <span class="c1"># [é¢„æµ‹å¯¹æ•°ï¼Œæ€»æ ·æœ¬æ•°]</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>               <span class="c1"># ç¦ç”¨æ¢¯åº¦ï¼ŒèŠ‚çœå†…å­˜å’Œè®¡ç®—</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data_iter</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">metric</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">accuracy</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>        <span class="c1"># è¿”å›å‡†ç¡®ç‡</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å¤šå˜é‡ç´¯åŠ å™¨å·¥å…·ç±»</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Accumulator</span><span class="p">:</span>  <span class="c1">#@save</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;åœ¨nä¸ªå˜é‡ä¸Šç´¯åŠ &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>   <span class="c1"># åˆå§‹åŒ–é•¿åº¦ä¸ºnçš„åˆ—è¡¨</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">)]</span> <span class="c1"># ä½ç½®å¯¹é½ç›¸åŠ </span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># __getitem__æ˜¯pythonå†…ç½®çš„é­”æ³•æ–¹æ³•</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>    <span class="c1"># æ”¯æŒç´¢å¼•è¯»å–ï¼ˆobj[idx]ï¼‰</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ç¤ºä¾‹ï¼šè¯„ä¼°å½“å‰ç½‘ç»œåœ¨æµ‹è¯•é›†ä¸Šçš„å‡†ç¡®ç‡</span>
</span></span><span class="line"><span class="cl"><span class="n">evaluate_accuracy</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è®­ç»ƒä¸€è½®epoch</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">train_epoch_ch3</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">updater</span><span class="p">):</span>  <span class="c1">#@save</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;è®­ç»ƒæ¨¡å‹ä¸€ä¸ªè¿­ä»£å‘¨æœŸ&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">net</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>           <span class="c1"># å¦‚æœæ˜¯æ ‡å‡†æ¨¡å‹ï¼Œåˆ‡æ¢åˆ°è®­ç»ƒæ¨¡å¼</span>
</span></span><span class="line"><span class="cl">    <span class="n">metric</span> <span class="o">=</span> <span class="n">Accumulator</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="c1"># [æŸå¤±å’Œï¼Œé¢„æµ‹å¯¹æ•°ï¼Œæ ·æœ¬æ€»æ•°]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">train_iter</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å‰å‘ä¼ æ’­ï¼Œè®¡ç®—é¢„æµ‹å’ŒæŸå¤±</span>
</span></span><span class="line"><span class="cl">        <span class="n">y_hat</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">l</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># åå‘ä¼ æ’­ä¸å‚æ•°æ›´æ–°ï¼ˆä¸¤ç§æƒ…å†µï¼‰</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">updater</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">updater</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">l</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">updater</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">l</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">updater</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ç´¯åŠ ç»Ÿè®¡é‡</span>
</span></span><span class="line"><span class="cl">        <span class="n">metric</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span> <span class="n">accuracy</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è¿”å›å¹³å‡æŸå¤±å’Œå‡†ç¡®ç‡</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">metric</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è®­ç»ƒè¿‡ç¨‹åŠ¨ç”»å¯è§†åŒ–ç±»</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Animator</span><span class="p">:</span>  <span class="c1">#@save</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;åœ¨åŠ¨ç”»ä¸­ç»˜åˆ¶æ•°æ®ï¼ˆæ”¯æŒå¤šæ›²çº¿ï¼‰&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xscale</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">fmts</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;m--&#39;</span><span class="p">,</span> <span class="s1">&#39;g-.&#39;</span><span class="p">,</span> <span class="s1">&#39;r:&#39;</span><span class="p">),</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">legend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">legend</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">d2l</span><span class="o">.</span><span class="n">use_svg_display</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">nrows</span> <span class="o">*</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ä¼ é€’é…ç½®å‚æ•°ï¼Œä¾¿äºåç»­é‡ç»˜</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">config_axes</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">d2l</span><span class="o">.</span><span class="n">set_axes</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">xscale</span><span class="p">,</span> <span class="n">yscale</span><span class="p">,</span> <span class="n">legend</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmts</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fmts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å¢é‡å¼æ·»åŠ å¤šä¸ªæ•°æ®ç‚¹åˆ°æ›²çº¿</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s2">&#34;__len__&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&#34;__len__&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>   <span class="c1"># æ¸…é™¤æ—§å†…å®¹</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmts</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">config_axes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ€»æ§è®­ç»ƒä¸»æµç¨‹å‡½æ•°</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">train_ch3</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">updater</span><span class="p">):</span>  <span class="c1">#@save</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;è®­ç»ƒä¸»æ§æµç¨‹ï¼šæ¯epochè®­ç»ƒ/è¯„ä¼°/å¯è§†åŒ–&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">animator</span> <span class="o">=</span> <span class="n">Animator</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">legend</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train loss&#39;</span><span class="p">,</span> <span class="s1">&#39;train acc&#39;</span><span class="p">,</span> <span class="s1">&#39;test acc&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">train_metrics</span> <span class="o">=</span> <span class="n">train_epoch_ch3</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">updater</span><span class="p">)</span>  <span class="c1"># è®­ç»ƒä¸€è½®</span>
</span></span><span class="line"><span class="cl">        <span class="n">test_acc</span> <span class="o">=</span> <span class="n">evaluate_accuracy</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">)</span>                    <span class="c1"># æµ‹è¯•é›†è¯„ä¼°</span>
</span></span><span class="line"><span class="cl">        <span class="n">animator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">train_metrics</span> <span class="o">+</span> <span class="p">(</span><span class="n">test_acc</span><span class="p">,))</span>            <span class="c1"># ç”»æ›²çº¿</span>
</span></span><span class="line"><span class="cl">    <span class="n">train_loss</span><span class="p">,</span> <span class="n">train_acc</span> <span class="o">=</span> <span class="n">train_metrics</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è‡ªåŠ¨æ£€æµ‹æ¨¡å‹æ•ˆæœ</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">train_loss</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">train_loss</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">train_acc</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">train_acc</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">train_acc</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">test_acc</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">test_acc</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">test_acc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å­¦ä¹ ç‡</span>
</span></span><span class="line"><span class="cl"><span class="n">lr</span> <span class="o">=</span> <span class="mf">0.1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">updater</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ç”¨d2lçš„SGDä¼˜åŒ–å™¨</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">d2l</span><span class="o">.</span><span class="n">sgd</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="n">lr</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl"><span class="c1"># å¼€å§‹è®­ç»ƒå¹¶åŠ¨æ€å¯è§†åŒ–</span>
</span></span><span class="line"><span class="cl"><span class="n">train_ch3</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">,</span> <span class="n">cross_entropy</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">updater</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å¯è§†åŒ–é¢„æµ‹æ•ˆæœçš„å‡½æ•°</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">predict_ch3</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>  <span class="c1">#@save</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;éšæœºé€‰nå¼ å›¾ç‰‡ï¼Œå±•ç¤ºçœŸå®å’Œé¢„æµ‹æ ‡ç­¾&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">test_iter</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>    <span class="c1"># å–ç¬¬ä¸€ä¸ªbatch</span>
</span></span><span class="line"><span class="cl">    <span class="n">trues</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">get_fashion_mnist_labels</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>                 <span class="c1"># çœŸå®æ ‡ç­¾ï¼ˆè½¬æ–‡æœ¬ï¼‰</span>
</span></span><span class="line"><span class="cl">    <span class="n">preds</span> <span class="o">=</span> <span class="n">d2l</span><span class="o">.</span><span class="n">get_fashion_mnist_labels</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># é¢„æµ‹æ ‡ç­¾ï¼ˆè½¬æ–‡æœ¬ï¼‰</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># åˆå¹¶â€œçœŸå®+é¢„æµ‹â€ä½œä¸ºæ ‡é¢˜</span>
</span></span><span class="line"><span class="cl">    <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="n">true</span> <span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">pred</span> <span class="k">for</span> <span class="n">true</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trues</span><span class="p">,</span> <span class="n">preds</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å¯è§†åŒ–å‰nå¼ å›¾ç‰‡åŠæ ‡ç­¾</span>
</span></span><span class="line"><span class="cl">    <span class="n">d2l</span><span class="o">.</span><span class="n">show_images</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="n">titles</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è¿è¡Œé¢„æµ‹å’Œå¯è§†åŒ–</span>
</span></span><span class="line"><span class="cl"><span class="n">predict_ch3</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="è¿è¡Œç»“æœ">è¿è¡Œç»“æœ
</h2><p><img src="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.6.-softmax%E5%9B%9E%E5%BD%92%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0/result.png"
	width="1062"
	height="611"
	srcset="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.6.-softmax%E5%9B%9E%E5%BD%92%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0/result_hu_234b4fc0e9ee174d.png 480w, /p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.6.-softmax%E5%9B%9E%E5%BD%92%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0/result_hu_3a2da627cb334b93.png 1024w"
	loading="lazy"
	
		alt="result"
	
	
		class="gallery-image" 
		data-flex-grow="173"
		data-flex-basis="417px"
	
></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/">å·¥ç¨‹å®è·µ</a>
        
            <a href="/tags/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ </a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Ending of the article</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-4.5.-%E6%9D%83%E9%87%8D%E8%A1%B0%E5%87%8F/">
        
        
            <div class="article-image">
                <img src="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-4.5.-%E6%9D%83%E9%87%8D%E8%A1%B0%E5%87%8F/index.4d851afd09f5d7c7ef7d4420fd9a2d86_hu_eda410826cd73b44.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -4.5. æƒé‡è¡°å‡"
                        
                        data-hash="md5-TYUa/Qn118fvfUQg/Zothg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -4.5. æƒé‡è¡°å‡</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-4.3.-%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA%E7%9A%84%E7%AE%80%E6%B4%81%E5%AE%9E%E7%8E%B0/">
        
        
            <div class="article-image">
                <img src="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-4.3.-%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA%E7%9A%84%E7%AE%80%E6%B4%81%E5%AE%9E%E7%8E%B0/index.a0c2c9a5bf1da022bfdcbbf6453fa436_hu_c9f179a39bbb64ad.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -4.3. å¤šå±‚æ„ŸçŸ¥æœºçš„ç®€æ´å®ç°"
                        
                        data-hash="md5-oMLJpb8doCK/3Lv2RT&#43;kNg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -4.3. å¤šå±‚æ„ŸçŸ¥æœºçš„ç®€æ´å®ç°</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-4.2.-%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0/">
        
        
            <div class="article-image">
                <img src="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-4.2.-%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0/index.f0c0f6b5b15e39646846ed0b1395143f_hu_6cf6f1aa82c0b13e.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -4.2. å¤šå±‚æ„ŸçŸ¥æœºçš„ä»é›¶å¼€å§‹å®ç°"
                        
                        data-hash="md5-8MD2tbFeOWRoRu0LE5UUPw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -4.2. å¤šå±‚æ„ŸçŸ¥æœºçš„ä»é›¶å¼€å§‹å®ç°</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.7.-softmax%E5%9B%9E%E5%BD%92%E7%9A%84%E7%AE%80%E6%B4%81%E5%AE%9E%E7%8E%B0/">
        
        
            <div class="article-image">
                <img src="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.7.-softmax%E5%9B%9E%E5%BD%92%E7%9A%84%E7%AE%80%E6%B4%81%E5%AE%9E%E7%8E%B0/index.083a4b2cbfae1bf493f46dbf7a437fbb_hu_ca85e77e632e118e.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -3.7. softmaxå›å½’çš„ç®€æ´å®ç°"
                        
                        data-hash="md5-CDpLLL&#43;uG/ST9G2/ekN/uw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -3.7. softmaxå›å½’çš„ç®€æ´å®ç°</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.3.-%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92%E7%9A%84%E7%AE%80%E6%B4%81%E5%AE%9E%E7%8E%B0/">
        
        
            <div class="article-image">
                <img src="/p/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-3.3.-%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92%E7%9A%84%E7%AE%80%E6%B4%81%E5%AE%9E%E7%8E%B0/index.a8bfbf9954cafcc876f8bbd140610ce7_hu_bd904d7af168b8cb.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -3.3. çº¿æ€§å›å½’çš„ç®€æ´å®ç°"
                        
                        data-hash="md5-qL&#43;/mVTK/Mh2&#43;LvRQGEM5w==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ -3.3. çº¿æ€§å›å½’çš„ç®€æ´å®ç°</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 Wang Suyu
    </section>
    
    <section class="powerby">
        
            æ­¤ç½‘ç«™ä»…ç”¨æ¥è®°å½•ä¸ªäººå­¦ä¹ ç”Ÿæ´» <br/>
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<script
    src="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/ribbon.min.js"
    integrity="sha384-UEK8ZiP3VgFNP8KnKMKDmd4pAUAOJ59Y2Jo3ED2Z5qKQf6HLHovMxq7Beb9CLPUe"
    crossorigin="anonymous"
    size="300"
    alpha="0.2"
    zindex="-1"
    defer
></script>

    </body>
</html>
